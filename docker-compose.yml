# Astroport.ONE Docker Compose Configuration
# Simple one-command installation: docker-compose up -d
#
# This configuration provides:
# - IPFS node for decentralized storage
# - NOSTR relay (strfry) for decentralized social networking
# - UPassport API for file management (UPlanet File Contract)
# - Astroport Swarm Node Manager (12345.sh) for network synchronization
# - Automatic daily maintenance (20h12.process.sh via cron)
# - Hourly constellation sync (backfill_constellation.sh via _12345.sh)
#
# Ports:
# - 54321: uSPOT API (UPassport) - File upload/download
# - 8080: IPFS Gateway - Access IPFS content
# - 7777: NOSTR Relay (strfry) - NOSTR protocol
# - 12345: SYNC (Astroport Swarm Node Manager) - Network synchronization
# - 9090: Prometheus metrics server
# - 9100: Prometheus Node Exporter

version: '3.8'

services:
  astroport:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: astroport-one
    hostname: astroport.local
    restart: unless-stopped
    
    # Network mode for better IPFS/NOSTR connectivity
    network_mode: bridge
    
    # Port mappings
    ports:
      - "54321:54321"  # uSPOT API (UPassport)
      - "8080:8080"    # IPFS Gateway
      - "7777:7777"    # NOSTR Relay (strfry)
      - "12345:12345"  # SYNC (Astroport Swarm Node Manager)
      - "9090:9090"    # Prometheus metrics server
      - "9100:9100"    # Prometheus Node Exporter
    
    # Volume mounts for persistence
    # IMPORTANT: Storage requirements
    # - Each MULTIPASS user: 1-10 GB
    # - Each ZEN Card user: 128 GB
    # - IPFS cache: Can grow to several TB
    # - Recommended: 4+ TB for production satellite node
    # - Minimum: 1 TB for testing
    #
    # Volume details:
    # - astroport-data: User data (MULTIPASS: 1-10 GB each, ZEN Card: 128 GB each)
    #   + Persistent caches: tmp/$IPFSNODEID, tmp/coucou, tmp/flashmem, tmp/swarm
    #   + Economic data (wallets, game state, logs)
    #   + Cooperative governance data
    # - astroport-workspace: Repository clones and development files
    # - astroport-ipfs: IPFS distributed storage (can grow to several TB)
    volumes:
      - astroport-data:/home/astroport/.zen
      - astroport-workspace:/home/astroport/.zen/workspace
      - astroport-ipfs:/home/astroport/.ipfs
    
    # Environment variables
    environment:
      - TZ=Europe/Paris
      - WORKSPACE_DIR=/home/astroport/.zen/workspace
      - HOME=/home/astroport
      - USER=astroport
      - NON_INTERACTIVE=true
      # Optional: Captain setup (uncomment and configure to enable)
      # - SETUP_CAPTAIN=true
      # - CAPTAIN_EMAIL=your@email.com
      # - CAPTAIN_LAT=48.8566
      # - CAPTAIN_LON=2.3522
      # - SWARM_KEY_PATH=/path/to/swarm.key  # For UPlanet ·∫êEN
      # - UPLANET_TYPE=ZEN  # or ORIGIN
    
    # Resource limits (adjust as needed)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    
    # Health check (check if 12345.sh is running)
    healthcheck:
      test: ["CMD", "pgrep", "-f", "12345.sh", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # Increased to allow full startup
    
    # Command to start all services
    command: /home/astroport/docker-start.sh

volumes:
  # Main data volume - Grows with users (1-10 GB per MULTIPASS, 128 GB per ZEN Card)
  # Persistent caches: tmp/$IPFSNODEID, tmp/coucou, tmp/flashmem, tmp/swarm
  astroport-data:
    driver: local
    name: astroport-data
    # For production: Consider using a named volume on a large disk
    # Example: docker volume create --driver local --opt type=none --opt device=/mnt/large-disk/astroport-data --opt o=bind astroport-data
  
  # Workspace volume - Repository clones
  astroport-workspace:
    driver: local
    name: astroport-workspace
  
  # IPFS volume - Distributed storage (can grow to several TB)
  astroport-ipfs:
    driver: local
    name: astroport-ipfs
    # For production: Consider using a named volume on a large disk
    # Example: docker volume create --driver local --opt type=none --opt device=/mnt/large-disk/astroport-ipfs --opt o=bind astroport-ipfs

networks:
  default:
    name: astroport-network

